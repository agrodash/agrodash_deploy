{% extends 'base.html' %}
{% load dict_filters %}

{% block 'title' %}Faturamento - Agro Dash{% endblock %}

{% block 'body' %}
<style>
  /* Estilos para melhorar a visualização das tabelas */
  #tabelaGanho thead th.sticky,
  #tabelaEvolucao thead th.sticky {
    box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
  }
  
  #tabelaGanho tbody td.sticky,
  #tabelaEvolucao tbody td.sticky {
    box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
  }
  
  #tabelaGanho tbody tr:hover td.sticky,
  #tabelaEvolucao tbody tr:hover td.sticky {
    background-color: #f9fafb !important;
  }
  
  .dataTables_wrapper {
    position: relative;
  }
  
  .dataTables_scrollHead {
    border-bottom: 2px solid #e5e7eb;
  }
</style>
<el-dialog>
  <dialog id="sidebar" class="backdrop:bg-transparent xl:hidden">
    <el-dialog-backdrop class="fixed inset-0 bg-gray-900/80 transition-opacity duration-300 ease-linear data-closed:opacity-0"></el-dialog-backdrop>

    <div tabindex="0" class="fixed inset-0 flex focus:outline-none">
      <el-dialog-panel class="group/dialog-panel relative mr-16 flex w-full max-w-xs flex-1 transform transition duration-300 ease-in-out data-closed:-translate-x-full">
        <div class="absolute top-0 left-full flex w-16 justify-center pt-5 duration-300 ease-in-out group-data-closed/dialog-panel:opacity-0">
          <button type="button" command="close" commandfor="sidebar" class="-m-2.5 p-2.5">
            <span class="sr-only">Close sidebar</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 text-white">
              <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>

        <div class="relative flex grow flex-col gap-y-5 overflow-y-auto bg-gray-50 px-6">
          <div class="relative flex h-16 shrink-0 items-center">
            <img src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=600" alt="Agro Dash" class="h-8 w-auto" />
          </div>
          <nav class="relative flex flex-1 flex-col">
            <ul role="list" class="flex flex-1 flex-col gap-y-7">
              <li>
                <ul role="list" class="-mx-2 space-y-1">
                  <li>
                    <a href="{% url 'home' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Home
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'preencher_informacoes' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Settings
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'lotes' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M3.75 21h16.5M4.5 3h15m-15 0v18m15-18v18M9 3v18m6-18v18M4.5 9h15M4.5 15h15" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Lotes
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'lotes_dashboard' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M3 13l9 9 9-9M3 3l9 9 9-9" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Dashboard
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'nutricional' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M12 3v18m-9-9h18M6.34 6.34l11.32 11.32M17.66 6.34l-11.32 11.32" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Nutricional
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'nutricional_dashboard' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M3 13l9 9 9-9M3 3l9 9 9-9" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Dashboard Nutricional
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'faturamento' %}" class="group flex gap-x-3 rounded-md bg-gray-100 p-2 text-sm/6 font-semibold text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-indigo-600">
                        <path d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h1.125A2.25 2.25 0 0 1 21 13.5V15m-1.5-1.5v-1.5A2.25 2.25 0 0 0 18 10.5H15.75m-3.75 0H12m-1.5 1.5v6.75m0 0H12m-1.5-1.5H12m-1.5-1.5h1.125c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125H12m-1.5-1.5H9.75" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Faturamento
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'fluxo_caixa' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M12 6v12m-3-3h6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Fluxo de Caixa
                    </a>
                  </li>
                  <li>
                    <a href="{% url 'ponto_equilibrio' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                        <path d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364 6.364L16.95 16.95M7.05 7.05 4.636 4.636m14.728 0L16.95 7.05M7.05 16.95l-2.414 2.414" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                      Ponto de Equilíbrio
                    </a>
                  </li>
                </ul>
              </li>
              <li class="-mx-6 mt-auto">
                <a href="{% url 'logout' %}" class="flex items-center gap-x-4 px-6 py-3 text-sm/6 font-semibold text-gray-900 hover:bg-gray-100">
                  {% if user.avatar %}
                    <img src="{{ user.avatar.url }}" alt="" class="size-8 rounded-full bg-gray-100 object-cover outline -outline-offset-1 outline-black/5" />
                  {% else %}
                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="" class="size-8 rounded-full bg-gray-100 outline -outline-offset-1 outline-black/5" />
                  {% endif %}
                  <span class="sr-only">Your profile</span>
                  <span aria-hidden="true">{{ user.get_full_name }}</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </el-dialog-panel>
    </div>
  </dialog>
</el-dialog>

<div class="flex h-screen bg-gray-50">
  <!-- Sidebar Desktop -->
  <div class="hidden xl:inset-y-0 xl:z-50 xl:flex xl:w-72 xl:flex-col">
    <div class="flex grow flex-col gap-y-5 overflow-y-auto border-r border-gray-200 bg-gray-50 px-6">
      <div class="relative flex h-16 shrink-0 items-center">
        <img src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=600" alt="Agro Dash" class="h-8 w-auto" />
      </div>
      <nav class="relative flex flex-1 flex-col">
        <ul role="list" class="flex flex-1 flex-col gap-y-7">
          <li>
            <ul role="list" class="-mx-2 space-y-1">
              <li>
                <a href="{% url 'home' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                    <path d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  Home
                </a>
              </li>
              <li>
                <a href="{% url 'preencher_informacoes' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                    <path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  Settings
                </a>
              </li>
              <li>
                <a href="{% url 'lotes' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                    <path d="M3.75 21h16.5M4.5 3h15m-15 0v18m15-18v18M9 3v18m6-18v18M4.5 9h15M4.5 15h15" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  Lotes
                </a>
              </li>
              <li>
                <a href="{% url 'lotes_dashboard' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                    <path d="M3 13l9 9 9-9M3 3l9 9 9-9" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  Dashboard
                </a>
              </li>
              <li>
                <a href="{% url 'nutricional' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                    <path d="M12 3v18m-9-9h18M6.34 6.34l11.32 11.32M17.66 6.34l-11.32 11.32" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  Nutricional
                </a>
              </li>
              <li>
                <a href="{% url 'nutricional_dashboard' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                    <path d="M3 13l9 9 9-9M3 3l9 9 9-9" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  Dashboard Nutricional
                </a>
              </li>
              <li>
                <a href="{% url 'faturamento' %}" class="group flex gap-x-3 rounded-md bg-gray-100 p-2 text-sm/6 font-semibold text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-indigo-600">
                    <path d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h1.125A2.25 2.25 0 0 1 21 13.5V15m-1.5-1.5v-1.5A2.25 2.25 0 0 0 18 10.5H15.75m-3.75 0H12m-1.5 1.5v6.75m0 0H12m-1.5-1.5H12m-1.5-1.5h1.125c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125H12m-1.5-1.5H9.75" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  Faturamento
                </a>
              </li>
              <li>
                <a href="{% url 'fluxo_caixa' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                    <path d="M12 6v12m-3-3h6M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                Fluxo de Caixa
              </a>
            </li>
            <li>
              <a href="{% url 'ponto_equilibrio' %}" class="group flex gap-x-3 rounded-md p-2 text-sm/6 font-semibold text-gray-700 hover:bg-gray-100 hover:text-indigo-600">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6 shrink-0 text-gray-400 group-hover:text-indigo-600">
                  <path d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364 6.364L16.95 16.95M7.05 7.05 4.636 4.636m14.728 0L16.95 7.05M7.05 16.95l-2.414 2.414" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Ponto de Equilíbrio
              </a>
            </li>
          </ul>
        </li>
          <li class="-mx-6 mt-auto">
            <a href="{% url 'logout' %}" class="flex items-center gap-x-4 px-6 py-3 text-sm/6 font-semibold text-gray-900 hover:bg-gray-100">
              {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="" class="size-8 rounded-full bg-gray-100 object-cover outline -outline-offset-1 outline-black/5" />
              {% else %}
                <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="" class="size-8 rounded-full bg-gray-100 outline -outline-offset-1 outline-black/5" />
              {% endif %}
              <span class="sr-only">Your profile</span>
              <span aria-hidden="true">{{ user.get_full_name }}</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto">
    <div class="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 bg-white px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8">
      <button type="button" command="open" commandfor="sidebar" class="-m-2.5 p-2.5 text-gray-700 xl:hidden">
        <span class="sr-only">Open sidebar</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-slot="icon" aria-hidden="true" class="size-6">
          <path d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
      <div class="h-6 w-px bg-gray-200 xl:hidden" aria-hidden="true"></div>
      <div class="flex flex-1 gap-x-4 self-stretch lg:gap-x-6">
        <div class="relative flex flex-1 items-center">
          <h1 class="text-xl font-semibold text-gray-900">Faturamento</h1>
        </div>
      </div>
    </div>

    {% if messages %}
      <div class="px-4 py-4 sm:px-6 lg:px-8">
        {% for message in messages %}
          <div class="rounded-md p-4 mb-2 {% if message.tags == 'error' %}bg-red-50 text-red-800{% elif message.tags == 'success' %}bg-green-50 text-green-800{% else %}bg-yellow-50 text-yellow-800{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <header class="border-b border-gray-200">
      <!-- Secondary navigation -->
      <nav class="flex overflow-x-auto py-4">
        <ul role="list" class="flex min-w-full flex-none gap-x-6 px-4 text-sm/6 font-semibold text-gray-500 sm:px-6 lg:px-8">
          <li>
            <a href="#gmd" onclick="showTab('gmd'); return false;" id="tab-gmd" class="text-indigo-600">GMD e Gráficos</a>
          </li>
          <li>
            <a href="#tabelas" onclick="showTab('tabelas'); return false;" id="tab-tabelas" class="">Tabelas</a>
          </li>
          <li>
            <a href="#rendimento" onclick="showTab('rendimento'); return false;" id="tab-rendimento" class="">Rendimento</a>
          </li>
          <li>
            <a href="#faturamento" onclick="showTab('faturamento'); return false;" id="tab-faturamento" class="">Faturamento</a>
          </li>
        </ul>
      </nav>
    </header>

    <!-- Tab: GMD e Gráficos -->
    <div id="content-gmd" class="tab-content">
    <!-- Formulário de GMD -->
    <div class="px-4 py-8 sm:px-6 lg:px-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Informar GMD (Ganho Médio Diário)</h2>
        <p class="text-sm text-gray-500 mb-4">Preencha o GMD para cada lote. O sistema calculará automaticamente o ganho de peso e a evolução.</p>
        <form method="POST" id="form-gmd">
          {% csrf_token %}
          <input type="hidden" name="calcular_faturamento" value="1">
          <input type="hidden" name="active_tab" id="active_tab_gmd" value="gmd">
          {% if lotes %}
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {% for lote in lotes %}
              {% if lote.projecoes_ganho.exists %}
              <div>
                <label for="gmd_lote_{{ lote.id }}" class="block text-sm font-medium text-gray-700 mb-1">
                  {{ lote.nome }} (kg/dia)
                </label>
                <input type="number" 
                       id="gmd_lote_{{ lote.id }}" 
                       name="gmd_lote_{{ lote.id }}" 
                       step="0.01" 
                       min="0" 
                       placeholder="Ex: 1.5"
                       {% if gmd_salvos and lote.id in gmd_salvos %}value="{{ gmd_salvos|get_item:lote.id }}"{% endif %}
                       class="block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
              </div>
              {% endif %}
              {% empty %}
              <p class="text-sm text-gray-500 col-span-full">Nenhum lote com projeções cadastrado. Cadastre lotes e projeções primeiro.</p>
              {% endfor %}
            </div>
            {% if not lotes %}
              <p class="text-sm text-gray-500">Nenhum lote cadastrado. Cadastre lotes primeiro.</p>
            {% endif %}
          {% else %}
            <p class="text-sm text-gray-500">Nenhum lote cadastrado. Cadastre lotes primeiro.</p>
          {% endif %}
          <div class="mt-6">
            <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
              Calcular Projeções
            </button>
          </div>
        </form>
      </div>
    </div>

      {% if tabela_ganho %}
      <!-- Gráfico de Ganho de Peso Mensal -->
      <div class="px-4 py-8 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            Ganho de Peso Mensal por Lote {% if gmd_display %}(GMD: {{ gmd_display|formatar_br:1 }}){% endif %}
          </h2>
          <div style="height: 400px; position: relative;">
            <canvas id="ganhoChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Gráfico de Evolução do Peso -->
      <div class="px-4 py-8 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Evolução do Peso por Lote</h2>
          <div style="height: 400px; position: relative;">
            <canvas id="evolucaoChart"></canvas>
          </div>
        </div>
      </div>
      {% else %}
      <div class="px-4 py-16 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <p class="text-sm text-gray-500">Preencha o GMD e clique em "Calcular Projeções" para ver os gráficos.</p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Tab: Tabelas -->
    <div id="content-tabelas" class="tab-content hidden">
    {% if tabela_ganho %}
    <!-- Tabelas lado a lado: Ganho de Peso e Evolução do Peso -->
    <div class="px-4 py-8 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Tabela 1: Ganho de Peso no Confinamento -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            GANHO DE PESO NO CONFINAMENTO (KG) {% if gmd_display %}P/{{ gmd_display|formatar_br:1 }} GMD{% endif %}
          </h2>
          <div class="overflow-x-auto">
            <table id="tabelaGanho" class="min-w-full divide-y divide-gray-300 border border-gray-300">
              <thead class="bg-gray-50">
                <tr>
                  <th class="border border-gray-300 px-4 py-3 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Lote</th>
                  <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider">Peso Entrada<br><span class="text-xs font-normal text-gray-600">(kg)</span></th>
                  {% for mes in meses_dados %}
                  <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider whitespace-nowrap">
                    {{ mes.mes_abrev }}/{{ mes.ano }}<br>
                    <span class="text-xs font-normal text-gray-600">({{ mes.dias }} dias)</span>
                  </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for linha in tabela_ganho %}
                <tr class="hover:bg-gray-50">
                  <td class="border border-gray-300 px-4 py-3 text-sm font-semibold text-gray-900 sticky left-0 bg-white z-10">{{ linha.lote_nome }}</td>
                  <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center font-medium">{{ linha.peso_entrada|formatar_br:2 }}</td>
                  {% for mes in meses_dados %}
                  <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center">
                    {% if mes.chave in linha.ganhos_por_mes %}
                      <span class="font-medium">{{ linha.ganhos_por_mes|get_item:mes.chave|formatar_br:2 }}</span>
                    {% else %}
                      <span class="text-gray-400">-</span>
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tabela 2: Evolução do Peso no Confinamento -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            EVOLUÇÃO DO PESO NO CONFINAMENTO (KG) {% if gmd_display %}P/{{ gmd_display|formatar_br:1 }} GMD{% endif %}
          </h2>
          <div class="overflow-x-auto">
            <table id="tabelaEvolucao" class="min-w-full divide-y divide-gray-300 border border-gray-300">
              <thead class="bg-gray-50">
                <tr>
                  <th class="border border-gray-300 px-4 py-3 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Lote</th>
                  <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider">Peso Entrada<br><span class="text-xs font-normal text-gray-600">(kg)</span></th>
                  {% for mes in meses_dados %}
                  <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider whitespace-nowrap">
                    {{ mes.mes_abrev }}/{{ mes.ano }}<br>
                    <span class="text-xs font-normal text-gray-600">({{ mes.dias }} dias)</span>
                  </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for linha in tabela_evolucao %}
                <tr class="hover:bg-gray-50">
                  <td class="border border-gray-300 px-4 py-3 text-sm font-semibold text-gray-900 sticky left-0 bg-white z-10">{{ linha.lote_nome }}</td>
                  <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center font-medium">{{ linha.peso_entrada|formatar_br:2 }}</td>
                  {% for mes in meses_dados %}
                  <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center">
                    {% if mes.chave in linha.pesos_por_mes %}
                      <span class="font-medium">{{ linha.pesos_por_mes|get_item:mes.chave|formatar_br:2 }}</span>
                    {% else %}
                      <span class="text-gray-400">0,00</span>
                    {% endif %}
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="px-4 py-16 sm:px-6 lg:px-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <p class="text-sm text-gray-500">Preencha o GMD e clique em "Calcular Projeções" para ver as tabelas.</p>
      </div>
    </div>
    {% endif %}
    </div>

    <!-- Tab: Rendimento -->
    <div id="content-rendimento" class="tab-content hidden">
    <!-- Formulário e Tabela de Rendimento de Carcaça -->
    <div class="px-4 py-8 sm:px-6 lg:px-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="mb-6">
          <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4">
            <p class="text-sm font-bold text-gray-900">
              O Rendimento de carcaça será informado pelo cliente/responsável, nesse exemplo foi de {% if rendimento_percentual %}{{ rendimento_percentual|formatar_br:0 }}%{% else %}55%{% endif %}
            </p>
          </div>
          <form method="POST" class="mb-4" id="form-rendimento">
            {% csrf_token %}
            <input type="hidden" name="calcular_rendimento" value="1">
            <input type="hidden" name="active_tab" id="active_tab_rendimento" value="rendimento">
            <div class="flex items-end gap-4">
              <div class="flex-1 max-w-xs">
                <label for="rendimento_carcaca" class="block text-sm font-medium text-gray-700 mb-1">
                  Rendimento de Carcaça (%)
                </label>
                <input type="number" 
                       id="rendimento_carcaca" 
                       name="rendimento_carcaca" 
                       step="0.01" 
                       min="0" 
                       max="100"
                       placeholder="Ex: 55"
                       {% if rendimento_percentual %}value="{{ rendimento_percentual|formatar_br:0 }}"{% endif %}
                       class="block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
              </div>
              <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                Calcular Rendimento
              </button>
            </div>
          </form>
        </div>
        
        {% if tabela_rendimento %}
        <div class="overflow-x-auto">
          <table id="tabelaRendimento" class="min-w-full divide-y divide-gray-300 border border-gray-300">
            <thead class="bg-gray-50">
              <tr>
                <th class="border border-gray-300 px-4 py-3 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider"></th>
                <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider">
                  RENDIMENTO {% if rendimento_percentual %}{{ rendimento_percentual|formatar_br:0 }}{% else %}55{% endif %}%<br><span class="text-xs font-normal text-gray-600">(@)</span>
                </th>
                <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider">
                  Quantidade<br><span class="text-xs font-normal text-gray-600">(animais)</span>
                </th>
                <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider">
                  Total<br><span class="text-xs font-normal text-gray-600">(@)</span>
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for linha in tabela_rendimento %}
              <tr class="hover:bg-gray-50">
                <td class="border border-gray-300 px-4 py-3 text-sm font-semibold text-gray-900">{{ linha.lote_nome }}</td>
                <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center font-medium">
                  {{ linha.rendimento_carcaca|formatar_br:2 }} @
                </td>
                <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center font-medium">
                  {{ linha.quantidade_animais|formatar_br:0 }}
                </td>
                <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center font-medium">
                  {{ linha.total_rendimento|formatar_br:2 }} @
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">Preencha o rendimento de carcaça e clique em "Calcular Rendimento" para ver os resultados.</p>
        {% endif %}
      </div>
    </div>
    </div>

    <!-- Tab: Faturamento -->
    <div id="content-faturamento" class="tab-content hidden">
    <!-- Formulário e Tabela de Faturamento -->
    {% if tabela_rendimento %}
    <div class="px-4 py-8 sm:px-6 lg:px-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">FATURAMENTO</h2>
        <form method="POST" class="mb-6" id="form-faturamento">
          {% csrf_token %}
          <input type="hidden" name="calcular_faturamento_valor" value="1">
          <input type="hidden" name="active_tab" id="active_tab_faturamento" value="faturamento">
          <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {% for linha in tabela_rendimento %}
            <div>
              <label for="valor_arroba_lote_{{ linha.lote_id }}" class="block text-sm font-medium text-gray-700 mb-1">
                {{ linha.lote_nome }} - Valor da @ (R$)
              </label>
              <input type="number" 
                     id="valor_arroba_lote_{{ linha.lote_id }}" 
                     name="valor_arroba_lote_{{ linha.lote_id }}" 
                     step="0.01" 
                     min="0" 
                     placeholder="Ex: 340,00"
                     {% if linha.lote_id in valor_arroba_salvos %}value="{{ valor_arroba_salvos|get_item:linha.lote_id|formatar_br:2 }}"{% endif %}
                     class="block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6">
            </div>
            {% endfor %}
          </div>
          <div class="mt-6">
            <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
              Calcular Faturamento
            </button>
          </div>
        </form>
        
        {% if tabela_faturamento %}
        <div class="overflow-x-auto">
          <table id="tabelaFaturamento" class="min-w-full divide-y divide-gray-300 border border-gray-300">
            <thead class="bg-gray-50">
              <tr>
                <th class="border border-gray-300 px-4 py-3 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider">Lote</th>
                <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider">Valor da @</th>
                <th class="border border-gray-300 px-4 py-3 text-center text-xs font-semibold text-gray-900 uppercase tracking-wider">Faturamento</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for linha in tabela_faturamento %}
              <tr class="hover:bg-gray-50">
                <td class="border border-gray-300 px-4 py-3 text-sm font-semibold text-gray-900">{{ linha.lote_nome }}</td>
                <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center font-medium">
                  R$ {{ linha.valor_arroba|formatar_br:2 }}
                </td>
                <td class="border border-gray-300 px-4 py-3 text-sm text-gray-700 text-center font-medium">
                  R$ {{ linha.faturamento|formatar_br:2 }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">Preencha o valor da @ para cada lote e clique em "Calcular Faturamento" para ver os resultados.</p>
        {% endif %}
      </div>
    </div>
    {% else %}
    <div class="px-4 py-16 sm:px-6 lg:px-8">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <p class="text-sm text-gray-500">Calcule o rendimento primeiro para acessar o faturamento.</p>
      </div>
    </div>
    {% endif %}
    </div>
  </main>
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

<!-- jQuery e DataTables JS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Dados dos gráficos
var chartDataGanho = {% if chart_data_ganho_json %}{{ chart_data_ganho_json|safe }}{% else %}{"labels": [], "datasets": []}{% endif %};
var chartDataEvolucao = {% if chart_data_evolucao_json %}{{ chart_data_evolucao_json|safe }}{% else %}{"labels": [], "datasets": []}{% endif %};
var ganhoChart = null;
var evolucaoChart = null;

// Função para criar opções do gráfico
function criarOpcoesGrafico(titulo, labelY, beginAtZero = false) {
  return {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      title: {
        display: true,
        text: titulo,
        font: {
          size: 16
        }
      },
      legend: {
        display: true,
        position: 'top'
      },
      tooltip: {
        mode: 'index',
        intersect: false,
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' kg';
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: beginAtZero,
        title: {
          display: true,
          text: labelY
        },
        ticks: {
          callback: function(value) {
            return value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' kg';
          }
        }
      },
      x: {
        title: {
          display: true,
          text: 'Período'
        }
      }
    },
    interaction: {
      mode: 'nearest',
      axis: 'x',
      intersect: false
    }
  };
}

// Inicializar DataTables
$(document).ready(function() {
  // Inicializar gráfico de Ganho de Peso Mensal (Barras)
  try {
    const ctxGanho = document.getElementById('ganhoChart');
    if (ctxGanho && chartDataGanho && chartDataGanho.datasets && chartDataGanho.datasets.length > 0) {
      ganhoChart = new Chart(ctxGanho, {
    type: 'bar',
    data: chartDataGanho,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Ganho de Peso Mensal no Confinamento',
          font: {
            size: 16
          }
        },
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' kg';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Ganho Mensal (kg)'
          },
          ticks: {
            callback: function(value) {
              return value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' kg';
            }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Período'
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    }
  });
    }
  } catch (e) {
    console.error('Erro ao criar gráfico de ganho:', e);
  }

  // Inicializar gráfico de Evolução do Peso
  try {
    const ctxEvolucao = document.getElementById('evolucaoChart');
    if (ctxEvolucao && chartDataEvolucao && chartDataEvolucao.datasets && chartDataEvolucao.datasets.length > 0) {
      evolucaoChart = new Chart(ctxEvolucao, {
        type: 'line',
        data: chartDataEvolucao,
        options: criarOpcoesGrafico('Evolução do Peso no Confinamento', 'Peso (kg)', false)
      });
    }
  } catch (e) {
    console.error('Erro ao criar gráfico de evolução:', e);
  }
  // DataTable para tabela de Ganho de Peso
  $('#tabelaGanho').DataTable({
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
    },
    pageLength: 25,
    order: [],
    scrollX: true,
    columnDefs: [
      { 
        targets: 0,
        className: 'text-left',
        orderable: true
      },
      {
        targets: '_all',
        className: 'text-center',
        orderable: true
      }
    ]
  });

  // DataTable para tabela de Evolução do Peso
  $('#tabelaEvolucao').DataTable({
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
    },
    pageLength: 25,
    order: [],
    scrollX: true,
    columnDefs: [
      { 
        targets: 0,
        className: 'text-left',
        orderable: true
      },
      {
        targets: '_all',
        className: 'text-center',
        orderable: true
      }
    ]
  });

  // DataTable para tabela de Rendimento
  $('#tabelaRendimento').DataTable({
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
    },
    pageLength: 25,
    order: [],
    searching: false,
    paging: false,
    info: false,
    columnDefs: [
      { 
        targets: 0,
        className: 'text-left',
        orderable: true
      },
      {
        targets: '_all',
        className: 'text-center',
        orderable: true
      }
    ]
  });

  // DataTable para tabela de Faturamento
  $('#tabelaFaturamento').DataTable({
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
    },
    pageLength: 25,
    order: [],
    searching: false,
    paging: false,
    info: false,
    columnDefs: [
      { 
        targets: 0,
        className: 'text-left',
        orderable: true
      },
      {
        targets: '_all',
        className: 'text-center',
        orderable: true
      }
    ]
  });
});

// Função para controlar as sub-abas
function showTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Remove active class from all tabs
  document.querySelectorAll('[id^="tab-"]').forEach(tab => {
    tab.classList.remove('text-indigo-600');
    tab.classList.add('text-gray-500');
  });
  
  // Show selected tab content
  const contentElement = document.getElementById('content-' + tabName);
  if (contentElement) {
    contentElement.classList.remove('hidden');
  }
  
  // Add active class to selected tab
  const activeTab = document.getElementById('tab-' + tabName);
  if (activeTab) {
    activeTab.classList.remove('text-gray-500');
    activeTab.classList.add('text-indigo-600');
  }
  
  // Salvar a aba ativa no sessionStorage
  sessionStorage.setItem('faturamento_active_tab', tabName);
}

// Função para obter a aba ativa do sessionStorage ou URL
function getActiveTab() {
  // Verificar se há parâmetro na URL (vindo do POST)
  const urlParams = new URLSearchParams(window.location.search);
  const tabFromUrl = urlParams.get('tab');
  if (tabFromUrl) {
    return tabFromUrl;
  }
  
  // Verificar sessionStorage
  const tabFromStorage = sessionStorage.getItem('faturamento_active_tab');
  if (tabFromStorage) {
    return tabFromStorage;
  }
  
  // Padrão: primeira aba
  return 'gmd';
}

// Inicializar com a aba salva ou padrão
document.addEventListener('DOMContentLoaded', function() {
  const activeTab = getActiveTab();
  showTab(activeTab);
  
  // Atualizar campos hidden dos formulários com a aba ativa
  document.getElementById('active_tab_gmd').value = activeTab;
  const activeTabRendimento = document.getElementById('active_tab_rendimento');
  if (activeTabRendimento) {
    activeTabRendimento.value = activeTab;
  }
  const activeTabFaturamento = document.getElementById('active_tab_faturamento');
  if (activeTabFaturamento) {
    activeTabFaturamento.value = activeTab;
  }
  
  // Adicionar event listeners aos formulários para salvar a aba antes de submeter
  const formGmd = document.getElementById('form-gmd');
  if (formGmd) {
    formGmd.addEventListener('submit', function(e) {
      // Obter a aba ativa atual (verificar qual aba está visível)
      let currentTab = 'gmd';
      document.querySelectorAll('.tab-content').forEach(content => {
        if (!content.classList.contains('hidden')) {
          const tabId = content.id.replace('content-', '');
          currentTab = tabId;
        }
      });
      // Se não encontrou, usar sessionStorage
      if (currentTab === 'gmd') {
        currentTab = sessionStorage.getItem('faturamento_active_tab') || 'gmd';
      }
      document.getElementById('active_tab_gmd').value = currentTab;
      sessionStorage.setItem('faturamento_active_tab', currentTab);
    });
  }
  
  const formRendimento = document.getElementById('form-rendimento');
  if (formRendimento) {
    formRendimento.addEventListener('submit', function(e) {
      // Obter a aba ativa atual (verificar qual aba está visível)
      let currentTab = 'rendimento';
      document.querySelectorAll('.tab-content').forEach(content => {
        if (!content.classList.contains('hidden')) {
          const tabId = content.id.replace('content-', '');
          currentTab = tabId;
        }
      });
      // Se não encontrou, usar sessionStorage
      if (currentTab === 'rendimento') {
        currentTab = sessionStorage.getItem('faturamento_active_tab') || 'rendimento';
      }
      document.getElementById('active_tab_rendimento').value = currentTab;
      sessionStorage.setItem('faturamento_active_tab', currentTab);
    });
  }
  
  const formFaturamento = document.getElementById('form-faturamento');
  if (formFaturamento) {
    formFaturamento.addEventListener('submit', function(e) {
      // Obter a aba ativa atual (verificar qual aba está visível)
      let currentTab = 'faturamento';
      document.querySelectorAll('.tab-content').forEach(content => {
        if (!content.classList.contains('hidden')) {
          const tabId = content.id.replace('content-', '');
          currentTab = tabId;
        }
      });
      // Se não encontrou, usar sessionStorage
      if (currentTab === 'faturamento') {
        currentTab = sessionStorage.getItem('faturamento_active_tab') || 'faturamento';
      }
      document.getElementById('active_tab_faturamento').value = currentTab;
      sessionStorage.setItem('faturamento_active_tab', currentTab);
    });
  }
});
</script>

{% endblock %}

